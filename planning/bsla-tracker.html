<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSLA Tracker - Taumata 10</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <!-- Theme sync - must be in head to prevent flash -->
    <script>
        // Theme sync with main site toggle
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Listen for theme changes from main site
            window.addEventListener('storage', function(e) {
                if (e.key === 'theme') {
                    if (e.newValue === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
        })();
    </script>
    
    <style>
        /* Only essential positioning/layout CSS that can't be done with Tailwind */
        
        .week-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .lesson-block {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 12px;
            align-items: start;
        }
        
        .copy-box {
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(243, 244, 246, 0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;" class="dark:bg-gray-900 dark:bg-opacity-95">
        <div class="text-center">
            <div class="text-6xl mb-4">üìö</div>
            <div class="text-xl font-semibold text-gray-700 dark:text-gray-300">Loading lesson data...</div>
        </div>
    </div>

    <div id="mainContent" style="display: none;">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <h1 class="text-4xl font-bold mb-2 text-gray-900 dark:text-gray-100">BSLA Lesson Tracker</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Taumata 10 - Better Start Literacy Approach - Year 4</p>

            <!-- Tabs -->
            <div class="flex gap-2 mb-6 border-b-2 border-gray-300 dark:border-gray-700">
                <button class="tab-btn px-6 py-3 font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" style="border-bottom: 3px solid currentColor;" data-tab="tracker">
                    Lesson Tracker
                </button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-tab="copy">
                    Weekly Planner
                </button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" data-tab="stats">
                    Overview
                </button>
            </div>

            <!-- Lesson Tracker Tab -->
            <div id="tracker" class="tab-content">
                <div class="flex gap-2 mb-6 flex-wrap">
                    <button id="exportBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white font-semibold rounded-md transition-colors">
                        Export ‚§ì
                    </button>
                    <button id="importBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white font-semibold rounded-md transition-colors">
                        Import ‚§í
                    </button>
                    <button id="resetBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 text-white font-semibold rounded-md transition-colors">
                        Reset ‚Üª
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-blue-600 dark:text-blue-400" id="completedCount">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Lessons Complete</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-gray-900 dark:text-gray-100" id="totalCount">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Total Lessons</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-green-600 dark:text-green-400" id="progressPercent">0%</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Progress</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Select Week:</div>
                    <div class="week-selector" id="weekSelector"></div>
                </div>

                <div id="weekContent"></div>
            </div>

            <!-- Weekly Planner Tab -->
            <div id="copy" class="tab-content hidden">
                <div class="bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                    <div class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Next 5 Incomplete Days</div>
                    <div class="text-sm text-blue-800 dark:text-blue-200">Copy lesson plans for the week ahead. Check off days as you complete them.</div>
                </div>
                <div id="copyContainer"></div>
            </div>

            <!-- Overview Tab -->
            <div id="stats" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">Overall Progress</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-blue-600 dark:text-blue-400" id="statsCompleted">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Completed</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-gray-900 dark:text-gray-100" id="statsTotal">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Total</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-green-600 dark:text-green-400" id="statsProgress">0%</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Progress</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <div id="statsDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global lesson data
        let LESSON_DATA = null;

        class BSLATracker {
            constructor() {
                this.progress = this.loadProgress();
                this.currentWeek = 1;
            }

            async init() {
                try {
                    // Determine base path for JSON
                    const basePath = './data/';
                    
                    // Fetch lesson data
                    const response = await fetch(basePath + 'taumata10-lessons.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load lesson data: ${response.status} ${response.statusText}`);
                    }
                    
                    LESSON_DATA = await response.json();
                    
                    // Hide loading, show content
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    this.setupEventListeners();
                    this.renderWeekSelector();
                    this.renderWeek();
                    this.updateStats();
                    this.renderCopyText();
                    this.renderStats();
                    
                } catch (error) {
                    console.error('Error loading lesson data:', error);
                    document.getElementById('loadingOverlay').innerHTML = `
                        <div class="text-center max-w-2xl mx-auto p-6">
                            <div class="text-6xl mb-4">‚ùå</div>
                            <div class="text-xl font-semibold text-red-600 dark:text-red-400 mb-4">Failed to load lesson data</div>
                            <div class="text-gray-700 dark:text-gray-300 mb-4">${error.message}</div>
                            <button onclick="location.reload()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md">Retry</button>
                        </div>
                    `;
                }
            }

            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });

                // Export/Import/Reset
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('importBtn').addEventListener('click', () => {
                    document.getElementById('importFile').click();
                });
                document.getElementById('importFile').addEventListener('change', (e) => this.importData(e));
                document.getElementById('resetBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                        this.progress = {};
                        this.saveProgress();
                        this.renderWeek();
                        this.updateStats();
                        this.renderCopyText();
                        this.renderStats();
                    }
                });
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(t => {
                    t.classList.remove('text-blue-600', 'dark:text-blue-400');
                    t.classList.add('text-gray-500', 'dark:text-gray-400');
                    t.style.borderBottom = '';
                });
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                activeTab.classList.add('text-blue-600', 'dark:text-blue-400');
                activeTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                activeTab.style.borderBottom = '3px solid currentColor';
                
                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(tabName).classList.remove('hidden');

                // Render tab-specific content
                if (tabName === 'copy') this.renderCopyText();
                else if (tabName === 'stats') this.renderStats();
            }

            renderWeekSelector() {
                const container = document.getElementById('weekSelector');
                container.innerHTML = '';

                Object.keys(LESSON_DATA).forEach(week => {
                    const btn = document.createElement('button');
                    btn.textContent = `Week ${week}`;
                    btn.className = `px-4 py-2 border-2 rounded-md font-medium transition-all ${
                        parseInt(week) === this.currentWeek
                            ? 'bg-blue-600 dark:bg-blue-700 text-white border-blue-600 dark:border-blue-700'
                            : 'bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 border-blue-600 dark:border-blue-700 hover:bg-blue-50 dark:hover:bg-gray-700'
                    }`;
                    btn.addEventListener('click', () => {
                        this.currentWeek = parseInt(week);
                        this.renderWeekSelector();
                        this.renderWeek();
                    });
                    container.appendChild(btn);
                });
            }

            renderWeek() {
                const container = document.getElementById('weekContent');
                const weekData = LESSON_DATA[this.currentWeek];
                
                if (!weekData) {
                    container.innerHTML = '<div class="text-center text-gray-600 dark:text-gray-400 py-8">Week not found</div>';
                    return;
                }

                let html = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2">Week ${this.currentWeek}: ${weekData.focus}</h2>
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            <strong>Target Words:</strong> ${weekData.targetWords}<br>
                            <strong>Reading Theme:</strong> ${weekData.readingTheme}
                        </div>
                    </div>
                `;

                weekData.days.forEach((dayLessons, dayIndex) => {
                    // Check if all lessons in this day are completed
                    const allCompleted = dayLessons.every((_, lessonIndex) => {
                        const lessonId = `${this.currentWeek}-${dayIndex}-${lessonIndex}`;
                        return this.progress[lessonId] === 'completed';
                    });

                    html += `
                        <div class="mb-6 border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="bg-gray-200 dark:bg-gray-700 px-4 py-3 border-b-2 border-gray-300 dark:border-gray-600 flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <span class="font-semibold text-gray-900 dark:text-gray-100">Day ${dayIndex + 1}</span>
                                </div>
                                <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white text-sm rounded transition-colors" onclick="tracker.markDayComplete(${this.currentWeek}, ${dayIndex}, ${!allCompleted})">
                                    ${allCompleted ? 'Unmark Day' : 'Mark Day Complete'}
                                </button>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-4">
                    `;

                    dayLessons.forEach((lesson, lessonIndex) => {
                        const lessonId = `${this.currentWeek}-${dayIndex}-${lessonIndex}`;
                        const status = this.progress[lessonId] || 'unmarked';
                        
                        const statusClasses = {
                            completed: 'bg-green-50 dark:bg-green-900 dark:bg-opacity-20 border-green-500 dark:border-green-600',
                            skipped: 'bg-red-50 dark:bg-red-900 dark:bg-opacity-20 border-red-500 dark:border-red-600 opacity-70',
                            unmarked: 'bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400'
                        };

                        html += `
                            <div class="lesson-block border-2 rounded-md p-3 mb-3 cursor-pointer transition-all ${statusClasses[status]}" 
                                 onclick="tracker.toggleLesson('${lessonId}')">
                                <div class="flex-shrink-0">
                                    <div class="w-5 h-5 border-2 rounded flex items-center justify-center mt-0.5 ${
                                        status === 'completed' 
                                            ? 'bg-green-600 dark:bg-green-500 border-green-600 dark:border-green-500' 
                                            : status === 'skipped'
                                            ? 'bg-red-600 dark:bg-red-500 border-red-600 dark:border-red-500'
                                            : 'bg-white dark:bg-gray-700 border-gray-400 dark:border-gray-500'
                                    }">
                                        ${status === 'completed' ? '<span class="text-white text-xs font-bold">‚úì</span>' : ''}
                                        ${status === 'skipped' ? '<span class="text-white text-xs font-bold">‚úï</span>' : ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900 dark:text-gray-100 mb-1">${lesson.component}</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">
                                        <span class="inline-block px-2 py-0.5 bg-blue-600 dark:bg-blue-700 text-white rounded text-xs font-semibold mr-2">
                                            ${lesson.duration}
                                        </span>
                                        ${lesson.lesson ? `<strong>${lesson.lesson}:</strong> ` : ''}${lesson.activity}
                                        <span class="inline-block px-2 py-0.5 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-xs font-semibold ml-2 border border-gray-300 dark:border-gray-600">
                                            ${lesson.source}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            toggleLesson(lessonId) {
                const currentStatus = this.progress[lessonId] || 'unmarked';
                
                // Cycle: unmarked -> completed -> skipped -> unmarked
                if (currentStatus === 'unmarked') {
                    this.progress[lessonId] = 'completed';
                } else if (currentStatus === 'completed') {
                    this.progress[lessonId] = 'skipped';
                } else {
                    this.progress[lessonId] = 'unmarked';
                }
                
                this.saveProgress();
                this.renderWeek();
                this.updateStats();
                this.renderCopyText();
            }

            markDayComplete(week, dayIndex, complete) {
                const dayLessons = LESSON_DATA[week].days[dayIndex];
                
                dayLessons.forEach((_, lessonIndex) => {
                    const lessonId = `${week}-${dayIndex}-${lessonIndex}`;
                    this.progress[lessonId] = complete ? 'completed' : 'unmarked';
                });
                
                this.saveProgress();
                this.renderWeek();
                this.updateStats();
                this.renderCopyText();
            }

            updateStats() {
                let totalLessons = 0;
                let completedLessons = 0;

                Object.keys(LESSON_DATA).forEach(week => {
                    LESSON_DATA[week].days.forEach(day => {
                        totalLessons += day.length;
                    });
                });

                Object.values(this.progress).forEach(status => {
                    if (status === 'completed') completedLessons++;
                });

                const progress = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;

                document.getElementById('completedCount').textContent = completedLessons;
                document.getElementById('totalCount').textContent = totalLessons;
                document.getElementById('progressPercent').textContent = `${progress}%`;

                document.getElementById('statsCompleted').textContent = completedLessons;
                document.getElementById('statsTotal').textContent = totalLessons;
                document.getElementById('statsProgress').textContent = `${progress}%`;
            }

            renderStats() {
                const container = document.getElementById('statsDetails');
                container.innerHTML = '<h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">Progress by Week</h3>';

                Object.keys(LESSON_DATA).forEach(week => {
                    const weekData = LESSON_DATA[week];
                    let weekTotal = 0;
                    let weekCompleted = 0;

                    weekData.days.forEach((day, dayIndex) => {
                        day.forEach((_, lessonIndex) => {
                            weekTotal++;
                            const lessonId = `${week}-${dayIndex}-${lessonIndex}`;
                            if (this.progress[lessonId] === 'completed') weekCompleted++;
                        });
                    });

                    const weekProgress = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;

                    const weekDiv = document.createElement('div');
                    weekDiv.className = 'mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0';
                    weekDiv.innerHTML = `
                        <div class="font-semibold text-gray-900 dark:text-gray-100">Week ${week}: ${weekData.focus}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">${weekCompleted} of ${weekTotal} lessons (${weekProgress}%)</div>
                    `;
                    container.appendChild(weekDiv);
                });
            }

            renderCopyText() {
                const container = document.getElementById('copyContainer');
                container.innerHTML = '';

                // Get all days across all weeks
                const allDays = [];
                Object.keys(LESSON_DATA).forEach(week => {
                    LESSON_DATA[week].days.forEach((dayLessons, dayIndex) => {
                        allDays.push({
                            week: parseInt(week),
                            dayIndex: dayIndex,
                            lessons: dayLessons,
                            weekData: LESSON_DATA[week]
                        });
                    });
                });

                // Filter to incomplete days and get next 5
                const incompleteDays = allDays.filter(day => {
                    const allDone = day.lessons.every((_, lessonIndex) => {
                        const lessonId = `${day.week}-${day.dayIndex}-${lessonIndex}`;
                        const status = this.progress[lessonId] || 'unmarked';
                        return status === 'completed' || status === 'skipped';
                    });
                    return !allDone;
                });

                const next5Days = incompleteDays.slice(0, 5);

                if (next5Days.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-600 dark:text-gray-400 py-8">All lessons complete! üéâ</div>';
                    return;
                }

                next5Days.forEach((day, displayIndex) => {
                    const allCompleted = day.lessons.every((_, lessonIndex) => {
                        const lessonId = `${day.week}-${day.dayIndex}-${lessonIndex}`;
                        return this.progress[lessonId] === 'completed';
                    });
                    
                    const dayBox = document.createElement('div');
                    dayBox.className = 'copy-box border border-gray-300 dark:border-gray-700 rounded-lg overflow-hidden';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'bg-gray-200 dark:bg-gray-700 px-4 py-3 flex justify-between items-center';
                    dayHeader.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" 
                                   class="w-4 h-4 cursor-pointer accent-blue-600" 
                                   data-week="${day.week}" 
                                   data-day="${day.dayIndex}"
                                   ${allCompleted ? 'checked' : ''}>
                            <span class="font-semibold text-gray-900 dark:text-gray-100">Day ${displayIndex + 1} (Week ${day.week}, Day ${day.dayIndex + 1})</span>
                        </div>
                        <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600 text-white text-sm rounded transition-colors" onclick="tracker.copyBox(this)">
                            Copy
                        </button>
                    `;
                    
                    // Add checkbox event listener
                    setTimeout(() => {
                        const checkbox = dayHeader.querySelector('input[type="checkbox"]');
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            this.markDayComplete(day.week, day.dayIndex, checkbox.checked);
                        });
                    }, 0);
                    
                    const dayContent = document.createElement('div');
                    dayContent.className = 'bg-white dark:bg-gray-800 p-0';
                    
                    // Build text with only non-skipped lessons
                    let dayText = '';
                    day.lessons.forEach((lesson, lessonIndex) => {
                        const lessonId = `${day.week}-${day.dayIndex}-${lessonIndex}`;
                        const status = this.progress[lessonId] || 'unmarked';
                        
                        if (status === 'skipped') return;
                        
                        dayText += `${lesson.component}\n`;
                        if (lesson.lesson) {
                            dayText += `${lesson.lesson}: ${lesson.activity}\n\n`;
                        } else {
                            dayText += `${lesson.activity}\n\n`;
                        }
                    });
                    
                    const dayTextarea = document.createElement('textarea');
                    dayTextarea.className = 'w-full min-h-[150px] p-4 border-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 resize-y font-mono text-sm';
                    dayTextarea.readOnly = true;
                    dayTextarea.value = dayText.trim();
                    
                    dayContent.appendChild(dayTextarea);
                    dayBox.appendChild(dayHeader);
                    dayBox.appendChild(dayContent);
                    container.appendChild(dayBox);
                });
            }

            copyBox(button) {
                const textarea = button.closest('.copy-box').querySelector('textarea');
                textarea.select();
                document.execCommand('copy');
                
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }

            exportData() {
                const data = JSON.stringify(this.progress, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bsla-progress-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.progress = JSON.parse(e.target.result);
                        this.saveProgress();
                        this.renderWeek();
                        this.updateStats();
                        this.renderCopyText();
                        this.renderStats();
                        alert('Progress imported successfully!');
                    } catch (err) {
                        alert('Error importing file. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }

            loadProgress() {
                const saved = localStorage.getItem('bsla-progress');
                return saved ? JSON.parse(saved) : {};
            }

            saveProgress() {
                localStorage.setItem('bsla-progress', JSON.stringify(this.progress));
            }
        }

        // Initialize tracker
        const tracker = new BSLATracker();
        tracker.init();
    </script>
</body>
</html>